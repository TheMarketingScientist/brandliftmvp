<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Password Reset Bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- === SET THIS TO YOUR STREAMLIT APP URL === -->
  <script>
    var APP_BASE_URL = "https://brandliftmvp-arrop87vgcjapptyjhszrn2.streamlit.app";
    // Write the meta refresh dynamically so we don't repeat the URL
    document.write('<meta http-equiv="refresh" content="3;url=' + APP_BASE_URL + '">');
  </script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif; margin: 2rem; }
    h1 { margin: 0 0 0.5rem; }
    p { margin: 0.25rem 0 0.75rem; }
    code { background: rgba(0,0,0,0.06); padding: 0.15rem 0.35rem; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Redirecting…</h1>
  <p>Please wait while we take you back to the app to finish resetting your password.</p>

  <noscript>
    <p><strong>JavaScript is required</strong> for password reset.</p>
    <p><a id="fallbackLink" href="#">Continue to the app</a>.</p>
    <script>
      // Fill in the noscript link dynamically too
      document.getElementById("fallbackLink").setAttribute("href", APP_BASE_URL);
    </script>
  </noscript>

  <script>
    (function () {
      function parseParams(s) {
        var out = {};
        if (!s) return out;
        s.replace(/^[#?]/, "").split("&").forEach(function (kv) {
          if (!kv) return;
          var i = kv.indexOf("=");
          var k = decodeURIComponent(i >= 0 ? kv.slice(0, i) : kv);
          var v = decodeURIComponent(i >= 0 ? kv.slice(i + 1) : "");
          out[k] = v;
        });
        return out;
      }

      // Supabase can return tokens in hash (#) or query (?)
      var hashParams = parseParams(window.location.hash);
      var queryParams = parseParams(window.location.search);

      // Prefer hash tokens, fall back to query
      var p = Object.assign({}, queryParams, hashParams);

      // Build redirect to Streamlit as QUERY (Streamlit can’t read hash)
      var redirect = new URL(APP_BASE_URL);
      var allowed = [
        "type", "code", "access_token", "refresh_token",
        "error", "error_code", "error_description"
      ];

      // Force type=recovery if tokens or code present
      if (p.access_token || p.refresh_token || p.code) {
        redirect.searchParams.set("type", "recovery");
      }

      // Forward known params
      allowed.forEach(function (k) {
        if (p[k]) redirect.searchParams.set(k, p[k]);
      });

      // Safety: even if no tokens, send user to the app so they can request a new email
      window.location.replace(redirect.toString());
    })();
  </script>
</body>
</html>

